#!/usr/bin/env bash

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

build_dir=$1
cache_dir=$2
bp_dir=$(cd $(dirname $0); cd ..; pwd)
vendor_dir=$build_dir/vendor
JRE_ARHIVE=jre-8u102-ea-bin-b04-linux-x64-25_apr_2016.tar.gz
JRE_ARHIVE_FILE=$bp_dir/files/$JRE_ARHIVE

# CF Common
BUILDPACK_PATH=$bp_dir
export BUILDPACK_PATH
source $bp_dir/compile-extensions/lib/common
# END CF Common
source $bp_dir/bin/common.sh

mkdir -p $vendor_dir

status "Extracting JRE."
cp $JRE_ARHIVE_FILE $vendor_dir
pushd $vendor_dir
  tar -xzf ./$JRE_ARHIVE
  rm $JRE_ARHIVE
  JRE_NAME=$(ls -l | tr " " "\n" | grep jre)
  JRE_DIR=$vendor_dir/$JRE_NAME
  status "Moving $JRE_NAME to target folder."
  mv $JRE_DIR jre
popd

status "Repacking jenkins.war."
pushd $build_dir
  zip -q -r jenkins.war * -x "vendor/*"
popd

# Update the PATH
status "Building runtime environment."
# see this script
# https://github.com/cloudfoundry/dea_ng/blob/e39ad94e5ea71c33ce91333803a1a956d652a738/lib/dea/starting/startup_script_generator.rb
mkdir -p $build_dir/.profile.d
# $HOME is set here https://github.com/cloudfoundry/dea_ng/blob/c2217e5fbcb866c9f4b6fd248b39138a83cbb479/lib/dea/starting/env.rb#L15
echo "export PATH=\"\$HOME/vendor/jre/bin:\$HOME/bin:\$PATH\";" > $build_dir/.profile.d/jre.sh

$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert -file /etc/ssl/certs/ca-certificates.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert1 -file /usr/local/share/ca-certificates/trusted_ca_1.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert2 -file /usr/local/share/ca-certificates/trusted_ca_2.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert3 -file /usr/local/share/ca-certificates/trusted_ca_3.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert4 -file /usr/local/share/ca-certificates/trusted_ca_4.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert5 -file /usr/local/share/ca-certificates/trusted_ca_5.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert6 -file /usr/local/share/ca-certificates/trusted_ca_6.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert7 -file /usr/local/share/ca-certificates/trusted_ca_7.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert8 -file /usr/local/share/ca-certificates/trusted_ca_8.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert9 -file /usr/local/share/ca-certificates/trusted_ca_9.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert10 -file /usr/local/share/ca-certificates/trusted_ca_10.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert11 -file /usr/local/share/ca-certificates/trusted_ca_11.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert12 -file /usr/local/share/ca-certificates/trusted_ca_12.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert13 -file /usr/local/share/ca-certificates/trusted_ca_13.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert14 -file /usr/local/share/ca-certificates/trusted_ca_14.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert15 -file /usr/local/share/ca-certificates/trusted_ca_15.crt
$vendor_dir/jre/bin/keytool -import -trustcacerts -keystore $vendor_dir/jre/lib/security/cacerts -storepass changeit -noprompt -alias cfcert16 -file /usr/local/share/ca-certificates/trusted_ca_16.crt

status "Done."